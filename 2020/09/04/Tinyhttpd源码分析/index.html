<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="开源," />










<meta name="description" content="学习记录，分析Http协议及TinyHttpd的学习过程。 TinyHttpd是一个简单的单文件http服务端程序，能够展示http服务器与客户端之间的信令交互流程。">
<meta property="og:type" content="article">
<meta property="og:title" content="Tinyhttpd源码分析">
<meta property="og:url" content="http://yoursite.com/2020/09/04/Tinyhttpd%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/index.html">
<meta property="og:site_name" content="咸鱼小站">
<meta property="og:description" content="学习记录，分析Http协议及TinyHttpd的学习过程。 TinyHttpd是一个简单的单文件http服务端程序，能够展示http服务器与客户端之间的信令交互流程。">
<meta property="og:image" content="https://s1.ax1x.com/2020/09/04/wigODs.jpg">
<meta property="og:image" content="https://s1.ax1x.com/2020/09/10/w8fhqO.png">
<meta property="og:image" content="https://s1.ax1x.com/2020/09/10/w8f7id.png">
<meta property="article:published_time" content="2020-09-03T16:46:00.000Z">
<meta property="article:modified_time" content="2020-09-10T14:57:58.849Z">
<meta property="article:author" content="HZhang">
<meta property="article:tag" content="开源">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://s1.ax1x.com/2020/09/04/wigODs.jpg">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2020/09/04/Tinyhttpd源码分析/"/>





  <title>Tinyhttpd源码分析 | 咸鱼小站</title>
  








<meta name="generator" content="Hexo 4.2.1"></head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">咸鱼小站</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">Learning, and coding.</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-program">
          <a href="/categories/program/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            编程
          </a>
        </li>
      
        
        <li class="menu-item menu-item-other">
          <a href="/categories/other/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            其他
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/09/04/Tinyhttpd%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="HZhang">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/me.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="咸鱼小站">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Tinyhttpd源码分析</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-09-04T00:46:00+08:00">
                2020-09-04
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/program/" itemprop="url" rel="index">
                    <span itemprop="name">编程</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2020/09/04/Tinyhttpd%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2020/09/04/Tinyhttpd源码分析/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2020/09/04/Tinyhttpd%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/" class="leancloud_visitors" data-flag-title="Tinyhttpd源码分析">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  4.8k
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  19
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <img src="https://s1.ax1x.com/2020/09/04/wigODs.jpg" alt="LAN、WLAN、WAN" style="zoom:40%;" />

<p>学习记录，分析Http协议及TinyHttpd的学习过程。</p>
<p>TinyHttpd是一个简单的单文件http服务端程序，能够展示http服务器与客户端之间的信令交互流程。</p>
<a id="more"></a>

<h4 id="1、HTTP协议"><a href="#1、HTTP协议" class="headerlink" title="1、HTTP协议"></a>1、HTTP协议</h4><blockquote>
<p> 在开始学习TinyHttpd源码之前，有必要先学习一下http协议，以便对代码有更深入的理解，不然可能会事倍功半。</p>
</blockquote>
<p>HTTP协议是一个简单的请求-响应协议，它通常运行在TCP/IP协议之上。它指定了客户端可能发送给服务器什么样的消息以及得到什么样的响应。<strong>请求和响应消息的头</strong>以ASCII码形式给出；而<strong>消息内容</strong>则具有一个类似MIME或XML的格式。</p>
<p>HTTP是基于<code>C/S模式</code>，且面向连接的。典型的HTTP事务处理有如下的过程：</p>
<blockquote>
<p>（1）客户与服务器建立连接；<br>（2）客户向服务器提出请求；<br>（3）服务器接受请求，并根据请求返回相应的文件作为应答<br>（4）客户与服务器关闭连接。</p>
</blockquote>
<p>在<strong>HTTP1.0</strong>中，客户与服务器之间的HTTP连接是一种一次性连接，它限制每次连接只处理一个请求，当服务器返回本次请求的应答后便立即关闭连接，下次请求再重新建立连接。这种一次性连接主要考虑到web服务器面向的是Internet中成干上万个用户，且只能提供有限个连接，故服务器不会让一个连接处于等待状态，及时地释放连接可以提高服务器的执行效率。而在<strong>HTTP1.1</strong>以后，默认的连接都是keep-alive的，即一次连接可以处理多个请求。</p>
<p>HTTP是一种<strong>无状态协议</strong>，即服务器不保留与客户进行交互时的任何状态。这就大大减轻了服务器负担，从而保持较快的响应速度。</p>
<p>HTTP是一种<strong>面向对象</strong>的协议。允许传送任意类型的数据对象。它通过<code>数据类型</code>和<code>长度</code>来标识所传送的数据内容和大小，并允许对数据进行压缩传送。</p>
<p>从技术上讲，HTTP服务端在一个特定的TCP端口（默认为80）上打开一个套接字，并且持续监听，等待客户端请求连接。当客户端与服务端建立连接之后，客户端即可通过该连接发送一个包含<strong>请求方法(method)</strong>的数据包，服务端会对该请求做出响应，并通过这条长链路返回给客户端。</p>
<p>HTTP规范定义了<strong>9种</strong>请求方法，每种请求方法规定了客户和服务器之间不同的信息交换方式。</p>
<table>
<thead>
<tr>
<th>method</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>GET</td>
<td>请求一个指定资源的表示形式. 使用GET的请求应该只被用于获取数据.</td>
</tr>
<tr>
<td>HEAD</td>
<td>请求一个与GET请求的响应相同的响应，但没有响应体.</td>
</tr>
<tr>
<td>POST</td>
<td>用于将实体提交到指定的资源，通常导致在服务器上的状态变化或副作用.</td>
</tr>
<tr>
<td>PUT</td>
<td>请求有效载荷替换目标资源的所有当前表示。</td>
</tr>
<tr>
<td>DELETE</td>
<td>删除指定的资源。</td>
</tr>
<tr>
<td>CONNECT</td>
<td>建立一个到由目标资源标识的服务器的隧道。</td>
</tr>
<tr>
<td>OPTIONS</td>
<td>用于描述目标资源的通信选项。</td>
</tr>
<tr>
<td>TRACE</td>
<td>沿着到目标资源的路径执行一个消息环回测试。</td>
</tr>
<tr>
<td>PATCH</td>
<td>用于对资源应用部分修改。</td>
</tr>
</tbody></table>
<p>常用的请求方法是<code>GET</code>和<code>POST</code>。服务器将根据客户请求完成相应操作，并以RSP数据包的形式返回给客户，最后关闭连接。</p>
<p>之前我们说过，HTTP是承载于TCP/IP之上的。HTTP请求的内容加上HTTP的头部信息即组成了HTTP的请求报文，也就是TCP报文的数据区部分。</p>
<img src="https://s1.ax1x.com/2020/09/10/w8fhqO.png" alt="HTTP请求报文" style="zoom:40%;" />

<p>同样，下面这张图展示了HTTP响应消息的报文结构。</p>
<img src="https://s1.ax1x.com/2020/09/10/w8f7id.png" alt="HTTP响应报文" style="zoom:40%;" />

<p>举个栗子：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">###post请求报文格式</span><br><span class="line">POST 　&#x2F;index.php　HTTP&#x2F;1.1 </span><br><span class="line">Host: localhost</span><br><span class="line">User-Agent: Mozilla&#x2F;5.0 (Windows NT 5.1; rv:10.0.2) Gecko&#x2F;20100101 Firefox&#x2F;10.0.2　　</span><br><span class="line">Accept: text&#x2F;html,application&#x2F;xhtml+xml,application&#x2F;xml;q&#x3D;0.9,&#x2F;;q&#x3D;0.8</span><br><span class="line">Accept-Language: zh-cn,zh;q&#x3D;0.5</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Connection: keep-alive</span><br><span class="line">Referer: http:&#x2F;&#x2F;localhost&#x2F;</span><br><span class="line">Content-Length：25</span><br><span class="line">Content-Type：application&#x2F;x-www-form-urlencoded</span><br><span class="line"></span><br><span class="line">username&#x3D;aa&amp;password&#x3D;1234</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">###响应报文格式</span><br><span class="line">HTTP&#x2F;1.1 200 OK　　</span><br><span class="line">Date: Sun, 17 Mar 2013 08:12:54 GMT　　</span><br><span class="line">Server: Apache&#x2F;2.2.8 (Win32) PHP&#x2F;5.2.5</span><br><span class="line">X-Powered-By: PHP&#x2F;5.2.5</span><br><span class="line">Set-Cookie: PHPSESSID&#x3D;c0huq7pdkmm5gg6osoe3mgjmm3; path&#x3D;&#x2F;</span><br><span class="line">Expires: Thu, 19 Nov 1981 08:52:00 GMT</span><br><span class="line">Cache-Control: no-store, no-cache, must-revalidate, post-check&#x3D;0, pre-check&#x3D;0</span><br><span class="line">Pragma: no-cache</span><br><span class="line">Content-Length: 4393</span><br><span class="line">Keep-Alive: timeout&#x3D;5, max&#x3D;100</span><br><span class="line">Connection: Keep-Alive</span><br><span class="line">Content-Type: text&#x2F;html; charset&#x3D;utf-8</span><br><span class="line"></span><br><span class="line">&lt;html&gt;　　</span><br><span class="line">&lt;head&gt;</span><br><span class="line">&lt;title&gt;xxx&lt;title&gt;</span><br><span class="line">&lt;&#x2F;head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">Hello world!</span><br><span class="line">&lt;&#x2F;body&gt;</span><br><span class="line">&lt;&#x2F;html&gt;</span><br></pre></td></tr></table></figure>



<p>HTTP的报文大致就是这么个样子。如<code>TinyHttpd</code>这样的http服务端，它们的功能可以很简要的概况为以下几点：</p>
<blockquote>
<p>1、监听指定TCP端口，接受用户请求，与用户建立连接。(高并发场景)</p>
<p>2、接收用户的请求数据包并进行解析。</p>
<p>3、根据解析得到的结果，判断用户的请求类型，并给出相应的反馈。(主要业务逻辑)</p>
</blockquote>
<p>重点的部分其实一个是在于如何能够在高并发的场景下接入大量的用户请求，另一个是对用户的不同请求做出相应的反馈。例如用户请求显示一个网页，这时就需要去读取网页相应的内容发送给客户，或者用户请求写入某个数据，这时就需要读取用户写入的数据，并存入文件或者数据库当中。具体的业务逻辑一般是在上面的第3点当中实现的，像TinyHttpd这样的示例程序并没有复杂的逻辑在里面，主要还是展示了如何对用户的请求进行处理的过程。</p>
<p>以上就是对HTTP协议及其服务端功能的简要介绍，了解了这些之后，就可以开始学习TinyHttpd的源码了。</p>
<h4 id="二、TinyHttpd源码分析"><a href="#二、TinyHttpd源码分析" class="headerlink" title="二、TinyHttpd源码分析"></a>二、TinyHttpd源码分析</h4><p>TinyHttpd是一个简单的http服务器实现，只有一个C文件和一个头文件。除了main函数外，共有12个函数，以下是函数声明。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span>  <span class="title">accept_request</span><span class="params">(<span class="keyword">int</span>)</span></span>;       									<span class="comment">/*接收接入请求*/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span>  <span class="title">bad_request</span><span class="params">(<span class="keyword">int</span>)</span></span>;												<span class="comment">/*返回400 Bad Request*/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span>  <span class="title">cat</span><span class="params">(<span class="keyword">int</span>, FILE *)</span></span>;												<span class="comment">/*读取本地文件，返回给客户端*/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span>  <span class="title">cannot_execute</span><span class="params">(<span class="keyword">int</span>)</span></span>;											<span class="comment">/*管道或fork出现错误，返回500 Internal Server Error*/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span>  <span class="title">error_die</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *)</span></span>;										<span class="comment">/*打印错误，并退出程序*/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span>  <span class="title">execute_cgi</span><span class="params">(<span class="keyword">int</span>, <span class="keyword">const</span> <span class="keyword">char</span> *, <span class="keyword">const</span> <span class="keyword">char</span> *, <span class="keyword">const</span> <span class="keyword">char</span> *)</span></span>;   <span class="comment">/*执行CGI脚本*/</span></span><br><span class="line"><span class="function"><span class="keyword">int</span>   <span class="title">get_line</span><span class="params">(<span class="keyword">int</span>, <span class="keyword">char</span> *, <span class="keyword">int</span>)</span></span>;									<span class="comment">/*从socket输出缓冲中读取一行*/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span>  <span class="title">headers</span><span class="params">(<span class="keyword">int</span>, <span class="keyword">const</span> <span class="keyword">char</span> *)</span></span>;									<span class="comment">/*返回200 OK*/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span>  <span class="title">not_found</span><span class="params">(<span class="keyword">int</span>)</span></span>;												<span class="comment">/*返回404 NOT FOUND*/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span>  <span class="title">serve_file</span><span class="params">(<span class="keyword">int</span>, <span class="keyword">const</span> <span class="keyword">char</span> *)</span></span>;   								<span class="comment">/*为客户端返回文件*/</span></span><br><span class="line"><span class="function"><span class="keyword">int</span>   <span class="title">startup</span><span class="params">(u_short *)</span></span>;    										<span class="comment">/*启动服务*/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span>  <span class="title">unimplemented</span><span class="params">(<span class="keyword">int</span>)</span></span>;											<span class="comment">/*请求方法错误，返回501 Method Not Implemented*/</span></span><br></pre></td></tr></table></figure>

<p>几个主要的函数如下，这几个函数构成了服务器的主要功能：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span>  <span class="title">accept_request</span><span class="params">(<span class="keyword">int</span>)</span></span>;       									<span class="comment">/*接收接入请求*/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span>  <span class="title">execute_cgi</span><span class="params">(<span class="keyword">int</span>, <span class="keyword">const</span> <span class="keyword">char</span> *, <span class="keyword">const</span> <span class="keyword">char</span> *, <span class="keyword">const</span> <span class="keyword">char</span> *)</span></span>;   <span class="comment">/*执行CGI脚本*/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span>  <span class="title">serve_file</span><span class="params">(<span class="keyword">int</span>, <span class="keyword">const</span> <span class="keyword">char</span> *)</span></span>;   								<span class="comment">/*为客户端返回文件*/</span></span><br><span class="line"><span class="function"><span class="keyword">int</span>   <span class="title">startup</span><span class="params">(u_short *)</span></span>;    										<span class="comment">/*启动服务*/</span></span><br></pre></td></tr></table></figure>

<p>代码阅读流程。</p>
<p><code>main()</code>-&gt;<code>startup()</code>-&gt;<code>accept_request()</code>-&gt;<code>serve_file()</code>-&gt;<code>execute_cgi()</code></p>
<p>以下进行拆分讲解，部分代码中应用到的小知识点会附在每部分的最后。</p>
<h4 id="1、main"><a href="#1、main" class="headerlink" title="1、main()"></a>1、main()</h4><p>main()函数的功能主要是在指定的port端口上启动服务(或者随机分配端口)，之后进入死循环，阻塞在accept()。直到有用户请求接入，此时接收请求之后会为该用户创建一个accept_request()线程处理这次请求。以下是代码。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> server_sock = <span class="number">-1</span>;</span><br><span class="line">    u_short port = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> client_sock = <span class="number">-1</span>;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">client_name</span>;</span></span><br><span class="line">    <span class="keyword">int</span> client_name_len = <span class="keyword">sizeof</span>(client_name);</span><br><span class="line">    <span class="keyword">pthread_t</span> newthread;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*在指定port上监听，port=0时随机分配端口，并将端口号赋值给port*/</span></span><br><span class="line">    server_sock = startup(&amp;port);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"httpd running on port %d\n"</span>, port);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">/*accept接入请求*/</span></span><br><span class="line">        client_sock = accept(server_sock, (struct sockaddr *)&amp;client_name, &amp;client_name_len);</span><br><span class="line">        <span class="keyword">if</span> (client_sock == <span class="number">-1</span>)</span><br><span class="line">            error_die(<span class="string">"accept"</span>);</span><br><span class="line">        <span class="comment">/*为每个接入的用户创建一个线程处理请求*/</span></span><br><span class="line">        <span class="keyword">if</span> (pthread_create(&amp;newthread, <span class="literal">NULL</span>, accept_request, client_sock) != <span class="number">0</span>)</span><br><span class="line">            perror(<span class="string">"pthread_create"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">close</span>(server_sock);</span><br><span class="line">    <span class="keyword">return</span> (<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这部分没啥好说的，标准的服务端监听流程。</p>
<h4 id="2、startup"><a href="#2、startup" class="headerlink" title="2、startup()"></a>2、startup()</h4><p>再回过头看下main函数中的<code>startup()</code>，主要功能是创建套接字，并绑定指定端口，并且开始<code>listen()</code>。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">startup</span><span class="params">(u_short *port)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> httpd = <span class="number">0</span>;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">name</span>;</span></span><br><span class="line"></span><br><span class="line">    httpd = socket(PF_INET, SOCK_STREAM, <span class="number">0</span>); <span class="comment">/* PF_INET等价于AF_INET */</span></span><br><span class="line">    <span class="keyword">if</span> (httpd == <span class="number">-1</span>)</span><br><span class="line">        error_die(<span class="string">"socket"</span>);</span><br><span class="line">    <span class="built_in">memset</span>(&amp;name, <span class="number">0</span>, <span class="keyword">sizeof</span>(name));</span><br><span class="line">    name.sin_family = AF_INET;</span><br><span class="line">    name.sin_port = htons(*port);</span><br><span class="line">    name.sin_addr.s_addr = htonl(INADDR_ANY); <span class="comment">/* 监听本机所有ip的接入请求 */</span></span><br><span class="line">    <span class="keyword">if</span> (bind(httpd, (struct sockaddr *)&amp;name, <span class="keyword">sizeof</span>(name)) &lt; <span class="number">0</span>)</span><br><span class="line">        error_die(<span class="string">"bind"</span>);</span><br><span class="line">    <span class="keyword">if</span> (*port == <span class="number">0</span>) <span class="comment">/* 小知识点：bind的时候未指定端口会随机分配一个 */</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">int</span> namelen = <span class="keyword">sizeof</span>(name);</span><br><span class="line">        <span class="keyword">if</span> (getsockname(httpd, (struct sockaddr *)&amp;name, &amp;namelen) == <span class="number">-1</span>) <span class="comment">/* getsockname可以获取指定句柄的addr和len信息 */</span></span><br><span class="line">            error_die(<span class="string">"getsockname"</span>);</span><br><span class="line">        *port = ntohs(name.sin_port);<span class="comment">/* 将端口号写回port */</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">listen</span>(httpd, <span class="number">5</span>) &lt; <span class="number">0</span>) <span class="comment">/* 开始监听 */</span></span><br><span class="line">        error_die(<span class="string">"listen"</span>);</span><br><span class="line">    <span class="keyword">return</span> (httpd);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里有个小技巧，<code>bind()</code>一个<code>sockaddr</code>的时候，可以不指定端口，这时系统会自动分配一个未使用的端口号。如果想要知道系统为你分配了哪个端口号，可以通过<code>getsockname()</code>函数来获取指定socket上的<code>sockaddr</code>和<code>socklen</code>。</p>
<h4 id="3、accept-request"><a href="#3、accept-request" class="headerlink" title="3、accept_request()"></a>3、accept_request()</h4><p><code>accept_request()</code>是一个比较重要的函数，它是在每个用户接入后，主进程为每个用户分配的处理线程入口函数。</p>
<p>在这个函数中，将会对用户的请求类型进行判断，如果不是GET或POST请求，则会拒绝服务。通过请求的方法和URL来判断用户是动态请求还是静态请求，设置<code>cgi</code>标志位。提取用户请求URL中的路径信息，为用户返回请求的文件。最后，通过<code>cgi</code>标志位决判断请求类型，如果是静态请求，则直接返回请求URL中路径对应的文件，如果是动态请求，则执行CGI脚本。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">accept_request</span><span class="params">(<span class="keyword">int</span> client)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> buf[<span class="number">1024</span>];</span><br><span class="line">    <span class="keyword">int</span>  numchars;</span><br><span class="line">    <span class="keyword">char</span> method[<span class="number">255</span>];</span><br><span class="line">    <span class="keyword">char</span> url[<span class="number">255</span>];</span><br><span class="line">    <span class="keyword">char</span> path[<span class="number">512</span>];</span><br><span class="line">    <span class="keyword">size_t</span> i, j;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">stat</span> <span class="title">st</span>;</span></span><br><span class="line">    <span class="keyword">int</span> cgi = <span class="number">0</span>; <span class="comment">/* cgi=1表示需要执行cgi脚本 */</span></span><br><span class="line">    <span class="keyword">char</span> *query_string = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*读取第一行数据*/</span></span><br><span class="line">    numchars = get_line(client, buf, <span class="keyword">sizeof</span>(buf));</span><br><span class="line">    i = <span class="number">0</span>;</span><br><span class="line">    j = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (!ISspace(buf[j]) &amp;&amp; (i &lt; <span class="keyword">sizeof</span>(method) - <span class="number">1</span>))</span><br><span class="line">    &#123;   <span class="comment">/*获取method*/</span></span><br><span class="line">        method[i] = buf[j];</span><br><span class="line">        i++;j++;</span><br><span class="line">    &#125;</span><br><span class="line">    method[i] = <span class="string">'\0'</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/*不是GET和POST请求则拒绝服务*/</span></span><br><span class="line">    <span class="keyword">if</span> (strcasecmp(method, <span class="string">"GET"</span>) &amp;&amp; strcasecmp(method, <span class="string">"POST"</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        unimplemented(client);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/* POST请求需要执行CGI脚本 */</span></span><br><span class="line">    <span class="keyword">if</span> (strcasecmp(method, <span class="string">"POST"</span>) == <span class="number">0</span>)</span><br><span class="line">        cgi = <span class="number">1</span>;</span><br><span class="line">    </span><br><span class="line">    i = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (ISspace(buf[j]) &amp;&amp; (j &lt; <span class="keyword">sizeof</span>(buf)))</span><br><span class="line">        j++;</span><br><span class="line">    <span class="keyword">while</span> (!ISspace(buf[j]) &amp;&amp; (i &lt; <span class="keyword">sizeof</span>(url) - <span class="number">1</span>) &amp;&amp; (j &lt; <span class="keyword">sizeof</span>(buf)))</span><br><span class="line">    &#123;   <span class="comment">/*获取URL*/</span></span><br><span class="line">        url[i] = buf[j];</span><br><span class="line">        i++;j++;</span><br><span class="line">    &#125;</span><br><span class="line">    url[i] = <span class="string">'\0'</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/*GET请求中有query_string字段时执行CGI脚本，否则为静态请求*/</span></span><br><span class="line">    <span class="keyword">if</span> (strcasecmp(method, <span class="string">"GET"</span>) == <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        query_string = url; <span class="comment">/*从URL中提取query_string*/</span></span><br><span class="line">        <span class="keyword">while</span> ((*query_string != <span class="string">'?'</span>) &amp;&amp; (*query_string != <span class="string">'\0'</span>))</span><br><span class="line">            query_string++;</span><br><span class="line">        <span class="keyword">if</span> (*query_string == <span class="string">'?'</span>)<span class="comment">/*URL中包含‘？’为动态请求*/</span></span><br><span class="line">        &#123;</span><br><span class="line">            cgi = <span class="number">1</span>;</span><br><span class="line">            *query_string = <span class="string">'\0'</span>;</span><br><span class="line">            query_string++;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">sprintf</span>(path, <span class="string">"htdocs%s"</span>, url); <span class="comment">/*拼接文件路径*/</span></span><br><span class="line">    <span class="keyword">if</span> (path[<span class="built_in">strlen</span>(path) - <span class="number">1</span>] == <span class="string">'/'</span>)</span><br><span class="line">        <span class="built_in">strcat</span>(path, <span class="string">"index.html"</span>);</span><br><span class="line">    <span class="keyword">if</span> (stat(path, &amp;st) == <span class="number">-1</span>)<span class="comment">/*文件或者路径不存在*/</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">while</span> ((numchars &gt; <span class="number">0</span>) &amp;&amp; <span class="built_in">strcmp</span>(<span class="string">"\n"</span>, buf)) <span class="comment">/* 将头部信息读取并且丢弃 */</span></span><br><span class="line">            numchars = get_line(client, buf, <span class="keyword">sizeof</span>(buf));</span><br><span class="line">        not_found(client); <span class="comment">/*返回404*/</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> ((st.st_mode &amp; S_IFMT) == S_IFDIR) <span class="comment">/*PATH为路径*/</span></span><br><span class="line">            <span class="built_in">strcat</span>(path, <span class="string">"/index.html"</span>);<span class="comment">/*默认访问index.html*/</span></span><br><span class="line">        <span class="keyword">if</span> ((st.st_mode &amp; S_IXUSR) ||(st.st_mode &amp; S_IXGRP) ||(st.st_mode &amp; S_IXOTH)) <span class="comment">/*对该路径指向的文件具有执行权限*/</span></span><br><span class="line">            cgi = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">if</span> (!cgi)</span><br><span class="line">            serve_file(client, path); <span class="comment">/*静态请求*/</span></span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            execute_cgi(client, path, method, query_string); <span class="comment">/*动态请求*/</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">close</span>(client);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>对HTTP服务器的请求可以分为<code>动态请求</code>和<code>静态请求</code>。<strong>静态请求</strong>的典型例子就是html，即服务器可以直接返回的就是静态请求。</p>
<p>而<strong>动态请求</strong>的则不是独立存在于服务器上的一个网页文件，只有当用户发起请求时才能返回一个完整的网页，网页的部分内容存储在例如数据库中或是别的服务器上，根据用户的不同请求可以返回不同的内容。</p>
<blockquote>
<p>一般在URL当中包含<code>？</code>的都是动态链接。</p>
</blockquote>
<p>这里用到的<code>stat()</code>是一个获取指定路径文件状态的函数。它的函数原型为：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">stat</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> * path, struct stat *st)</span></span>;</span><br></pre></td></tr></table></figure>

<p><code>path</code>可以是一个文件或者路径，<code>st</code>是一个stat结构体的指针。<code>struct stat</code>用于存放<code>stat()</code>执行的结果，与<code>path</code>相关的所有文件信息均存放在该结构体中。该结构体的成员如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">stat</span> &#123;</span></span><br><span class="line">    <span class="keyword">dev_t</span> st_dev; 				<span class="comment">//文件的设备编号</span></span><br><span class="line">    <span class="keyword">ino_t</span> st_ino; 				<span class="comment">//文件的i-node</span></span><br><span class="line">    <span class="keyword">mode_t</span> st_mode;				<span class="comment">//文件的类型和存取的权限</span></span><br><span class="line">    <span class="keyword">nlink_t</span> st_nlink; 			<span class="comment">//连到该文件的硬连接数目, 刚建立的文件值为1.</span></span><br><span class="line">    <span class="keyword">uid_t</span> st_uid; 				<span class="comment">//文件所有者的用户识别码</span></span><br><span class="line">    <span class="keyword">gid_t</span> st_gid; 				<span class="comment">//文件所有者的组识别码</span></span><br><span class="line">    <span class="keyword">dev_t</span> st_rdev; 				<span class="comment">//若此文件为装置设备文件, 则为其设备编号</span></span><br><span class="line">    <span class="keyword">off_t</span> st_size; 				<span class="comment">//文件大小, 以字节计算</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> st_blksize; 	<span class="comment">//文件系统的I/O 缓冲区大小.</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> st_blocks;	<span class="comment">//占用文件区块的个数, 每一区块大小为512 个字节.</span></span><br><span class="line">    <span class="keyword">time_t</span> st_atime; 			<span class="comment">//文件最近一次被存取或被执行的时间</span></span><br><span class="line">    <span class="keyword">time_t</span> st_mtime; 			<span class="comment">//文件最后一次被修改的时间, 一般只有在用mknod、 utime 和write 时才会改变</span></span><br><span class="line">    <span class="keyword">time_t</span> st_ctime; 			<span class="comment">//最近一次被更改的时间, 此参数会在文件所有者、组、 权限被更改时更新</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>这里用到的<code>st_mode</code>用于描述文件的类型和相应的权限信息。<code>st_mode</code>其实本质就是一个<code>unsigned int</code>，最低的9位(0-8)是权限，9-11是id，12-15是类型。<code>S_IFMT</code>是掩码，<code>st_mode &amp; S_IFMT</code>即可得到文件类型。<code>st_mode</code>的具体各位信息如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">S_IFMT     0170000   bitmask for the file type bitfields</span><br><span class="line">S_IFSOCK   0140000   socket</span><br><span class="line">S_IFLNK    0120000   symbolic link</span><br><span class="line">S_IFREG    0100000   regular file</span><br><span class="line">S_IFBLK    0060000   block device</span><br><span class="line">S_IFDIR    0040000   directory</span><br><span class="line">S_IFCHR    0020000   character device</span><br><span class="line">S_IFIFO    0010000   fifo</span><br><span class="line">S_ISUID    0004000   set UID bit</span><br><span class="line">S_ISGID    0002000   set GID bit (see below)</span><br><span class="line">S_ISVTX    0001000   sticky bit (see below)</span><br><span class="line">S_IRWXU    00700     mask for file owner permissions</span><br><span class="line">S_IRUSR    00400     owner has read permission</span><br><span class="line">S_IWUSR    00200     owner has write permission</span><br><span class="line">S_IXUSR    00100     owner has execute permission</span><br><span class="line">S_IRWXG    00070     mask for group permissions</span><br><span class="line">S_IRGRP    00040     group has read permission</span><br><span class="line">S_IWGRP    00020     group has write permission</span><br><span class="line">S_IXGRP    00010     group has execute permission</span><br><span class="line">S_IRWXO    00007     mask for permissions for others (not in group)</span><br><span class="line">S_IROTH    00004     others have read permission</span><br><span class="line">S_IWOTH    00002     others have write permisson</span><br><span class="line">S_IXOTH    00001     others have execute permission</span><br></pre></td></tr></table></figure>

<h4 id="4、serve-file"><a href="#4、serve-file" class="headerlink" title="4、serve_file()"></a>4、serve_file()</h4><p><code>serve_file()</code>的功能主要是调用<code>cat()</code>函数将客户端请求的静态文件从磁盘中读取出来，返回给客户端。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">serve_file</span><span class="params">(<span class="keyword">int</span> client, <span class="keyword">const</span> <span class="keyword">char</span> *filename)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    FILE *resource = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">int</span> numchars = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">char</span> buf[<span class="number">1024</span>];</span><br><span class="line"></span><br><span class="line">    buf[<span class="number">0</span>] = <span class="string">'A'</span>;</span><br><span class="line">    buf[<span class="number">1</span>] = <span class="string">'\0'</span>;</span><br><span class="line">    <span class="keyword">while</span> ((numchars &gt; <span class="number">0</span>) &amp;&amp; <span class="built_in">strcmp</span>(<span class="string">"\n"</span>, buf)) <span class="comment">/* 丢弃头部信息 */</span></span><br><span class="line">        numchars = get_line(client, buf, <span class="keyword">sizeof</span>(buf));</span><br><span class="line">    </span><br><span class="line">    resource = fopen(filename, <span class="string">"r"</span>); <span class="comment">/*以读的方式打开文件*/</span></span><br><span class="line">    <span class="keyword">if</span> (resource == <span class="literal">NULL</span>)</span><br><span class="line">        not_found(client);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        headers(client, filename);<span class="comment">/*返回200 OK*/</span></span><br><span class="line">        cat(client, resource);<span class="comment">/*为服务器返回静态文件*/</span></span><br><span class="line">    &#125;</span><br><span class="line">    fclose(resource);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这部分也没啥好说的。</p>
<h4 id="5、execute-cgi"><a href="#5、execute-cgi" class="headerlink" title="5、execute_cgi()"></a>5、execute_cgi()</h4><p><code>execute_cgi()</code>函数的主要功能是创建一个子进程及一对读写管道，子进程负责执行CGI脚本，父进程负责写入请求并读取结果返回给客户端。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">execute_cgi</span><span class="params">(<span class="keyword">int</span> client, <span class="keyword">const</span> <span class="keyword">char</span> *path, <span class="keyword">const</span> <span class="keyword">char</span> *method, <span class="keyword">const</span> <span class="keyword">char</span> *query_string)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> buf[<span class="number">1024</span>];</span><br><span class="line">    <span class="keyword">int</span> cgi_output[<span class="number">2</span>];</span><br><span class="line">    <span class="keyword">int</span> cgi_input[<span class="number">2</span>];</span><br><span class="line">    <span class="keyword">pid_t</span> pid;</span><br><span class="line">    <span class="keyword">int</span> status;</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    <span class="keyword">char</span> c;</span><br><span class="line">    <span class="keyword">int</span> numchars = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">int</span> content_length = <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">    buf[<span class="number">0</span>] = <span class="string">'A'</span>; <span class="comment">//?</span></span><br><span class="line">    buf[<span class="number">1</span>] = <span class="string">'\0'</span>;</span><br><span class="line">    <span class="keyword">if</span> (strcasecmp(method, <span class="string">"GET"</span>) == <span class="number">0</span>)             <span class="comment">/*忽略大小写比较字符串*/</span></span><br><span class="line">        <span class="keyword">while</span> ((numchars &gt; <span class="number">0</span>) &amp;&amp; <span class="built_in">strcmp</span>(<span class="string">"\n"</span>, buf)) <span class="comment">/* get_line读取，1、socket缓冲区无内容，2、读取到空行。功能：读取头部信息，并且丢弃 */</span></span><br><span class="line">            numchars = get_line(client, buf, <span class="keyword">sizeof</span>(buf));</span><br><span class="line">    <span class="keyword">else</span> <span class="comment">/* POST */</span></span><br><span class="line">    &#123;</span><br><span class="line">        numchars = get_line(client, buf, <span class="keyword">sizeof</span>(buf));</span><br><span class="line">        <span class="keyword">while</span> ((numchars &gt; <span class="number">0</span>) &amp;&amp; <span class="built_in">strcmp</span>(<span class="string">"\n"</span>, buf))</span><br><span class="line">        &#123;</span><br><span class="line">            buf[<span class="number">15</span>] = <span class="string">'\0'</span>;</span><br><span class="line">            <span class="keyword">if</span> (strcasecmp(buf, <span class="string">"Content-Length:"</span>) == <span class="number">0</span>) <span class="comment">/*读取Content-Length行（请求包头部分，可能有若干行，但这里只读取该行）*/</span></span><br><span class="line">                content_length = atoi(&amp;(buf[<span class="number">16</span>]));</span><br><span class="line">            numchars = get_line(client, buf, <span class="keyword">sizeof</span>(buf));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (content_length == <span class="number">-1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            bad_request(client); <span class="comment">/*返回 400 Bad Request*/</span></span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">sprintf</span>(buf, <span class="string">"HTTP/1.0 200 OK\r\n"</span>);</span><br><span class="line">    send(client, buf, <span class="built_in">strlen</span>(buf), <span class="number">0</span>); <span class="comment">/*返回200 OK*/</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (pipe(cgi_output) &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        cannot_execute(client);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (pipe(cgi_input) &lt; <span class="number">0</span>) <span class="comment">/*创建一对pipe*/</span></span><br><span class="line">    &#123;</span><br><span class="line">        cannot_execute(client);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/*注意：fork()可以创建一个与父进程几乎完全一样的子进程，但是只会拷贝调用fork的线程，其他的线程不会拷贝。*/</span></span><br><span class="line">    <span class="keyword">if</span> ((pid = fork()) &lt; <span class="number">0</span>) <span class="comment">/*创建一个子进程*/</span></span><br><span class="line">    &#123;</span><br><span class="line">        cannot_execute(client);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (pid == <span class="number">0</span>) <span class="comment">/* child: CGI script */</span></span><br><span class="line">    &#123;             <span class="comment">/*pid==0标志此进程为子进程，在子进程中执行CGI脚本*/</span></span><br><span class="line">        <span class="comment">/* 环境变量 */</span></span><br><span class="line">        <span class="keyword">char</span> meth_env[<span class="number">255</span>];</span><br><span class="line">        <span class="keyword">char</span> query_env[<span class="number">255</span>];</span><br><span class="line">        <span class="keyword">char</span> length_env[<span class="number">255</span>];</span><br><span class="line">    </span><br><span class="line">        <span class="comment">/* dup和dup2函数的功能时重定向文件描述符 */</span></span><br><span class="line">        <span class="comment">/* dup2(oldfd,newfd)可以将newfd重定向到oldfd */</span></span><br><span class="line">        dup2(cgi_output[<span class="number">1</span>], <span class="number">1</span>); <span class="comment">/* 将标准输出重定向到输出管道上 */</span></span><br><span class="line">        dup2(cgi_input[<span class="number">0</span>], <span class="number">0</span>);  <span class="comment">/* 将标准输入重定向到输入管道上 */</span></span><br><span class="line">        <span class="comment">/* 结合父进程代码可知，cgi_input管道：父进程-&gt;子进程，cgi_output管道：子进程-&gt;父进程 */</span></span><br><span class="line">        <span class="comment">/* 即input和output是相对于父进程而言的 */</span></span><br><span class="line">        <span class="built_in">close</span>(cgi_output[<span class="number">0</span>]); <span class="comment">/*子进程关闭输出管道的输出端*/</span></span><br><span class="line">        <span class="built_in">close</span>(cgi_input[<span class="number">1</span>]);  <span class="comment">/*子进程关闭输入管道的写入端*/</span></span><br><span class="line">        <span class="built_in">sprintf</span>(meth_env, <span class="string">"REQUEST_METHOD=%s"</span>, method);<span class="comment">/*设置环境变量*/</span></span><br><span class="line">        putenv(meth_env);</span><br><span class="line">        <span class="keyword">if</span> (strcasecmp(method, <span class="string">"GET"</span>) == <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">sprintf</span>(query_env, <span class="string">"QUERY_STRING=%s"</span>, query_string);</span><br><span class="line">            putenv(query_env);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123; <span class="comment">/* POST */</span></span><br><span class="line">            <span class="built_in">sprintf</span>(length_env, <span class="string">"CONTENT_LENGTH=%d"</span>, content_length);</span><br><span class="line">            putenv(length_env);</span><br><span class="line">        &#125;</span><br><span class="line">        execl(path, path, <span class="literal">NULL</span>);<span class="comment">/*调用execl()函数执行cgi脚本*/</span></span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123; <span class="comment">/* parent */</span></span><br><span class="line">        <span class="built_in">close</span>(cgi_output[<span class="number">1</span>]); <span class="comment">/*父进程关闭输出管道的写入端*/</span></span><br><span class="line">        <span class="built_in">close</span>(cgi_input[<span class="number">0</span>]);  <span class="comment">/*父进程关闭输入管道的输出端*/</span></span><br><span class="line">        <span class="keyword">if</span> (strcasecmp(method, <span class="string">"POST"</span>) == <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; content_length; i++)</span><br><span class="line">            &#123; <span class="comment">/*POST    将从客户端接收的字符写入cgi_input管道中*/</span></span><br><span class="line">                recv(client, &amp;c, <span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line">                <span class="built_in">write</span>(cgi_input[<span class="number">1</span>], &amp;c, <span class="number">1</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        <span class="comment">/* 从cgi_output管道中读取的数据发送给客户端 */</span></span><br><span class="line">        <span class="keyword">while</span> (<span class="built_in">read</span>(cgi_output[<span class="number">0</span>], &amp;c, <span class="number">1</span>) &gt; <span class="number">0</span>)</span><br><span class="line">            send(client, &amp;c, <span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line">    </span><br><span class="line">        <span class="built_in">close</span>(cgi_output[<span class="number">0</span>]);</span><br><span class="line">        <span class="built_in">close</span>(cgi_input[<span class="number">1</span>]);</span><br><span class="line">        waitpid(pid, &amp;status, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>PIPE的创建和关闭，如何组成一对输入输出管道</p>
<p><code>execute_cgi()</code>函数首先创建了一对管道<code>cig_input</code>和<code>cig_output</code>，之后调用<code>fork()</code>创建了一个子进程。需要指出的是，主进程当中只创建了<code>accept_request()</code>这一个线程，如果是在多线程的环境中，只有调用<code>fork()</code>的那个线程才会存活下来，其他的线程都会消失。因此在多线程环境当中需要注意<code>fork()</code>的使用。当然，这里使用<code>fork()</code>并没有啥影响，因为也有且只有一个线程存在。</p>
<p>调用<code>fork()</code>后可以通过返回值来区分父子进程，父进程中<code>fork()</code>的返回值为子进程的PID，而子进程的<code>fork()</code>返回值为0。因此，我们可以很好的区分父子进程，在子进程中将<code>cig_input</code>的输入端关闭，<code>cig_output</code>的输出端关闭，在父进程中将<code>cig_input</code>的输出端关闭，<code>cig_output</code>的输入端关闭，以此组成一对管道。管道的具体概念可以参见另一篇讲解UNIX进程间通信的blog。</p>
<blockquote>
<p><code>cig_input</code>对于父进程来说是输入管道，<code>cig_output</code>是输出管道。</p>
</blockquote>
<p>同时，在子进程当中，调用<code>dup2()</code>函数将<code>stdin</code>合<code>stdout</code>的文件描述符重定向到对应的管道当中，这样即可直接对管道进行读写操作。</p>
<p>至于CGI脚本的内容并没有细究，毕竟也不是做这个方向的。</p>
<p>参考文献：</p>
<p>[1] <a href="https://blog.csdn.net/yanzhenjie1003/article/details/93098495" target="_blank" rel="noopener">HTTP协议理解及服务端与客户端的设计实现</a></p>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/opensource/" rel="tag"># 开源</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2020/08/25/LAN%E3%80%81WLAN%E3%80%81WAN%E7%9A%84%E5%8C%BA%E5%88%AB/" rel="next" title="LAN、WLAN、WAN的区别">
                <i class="fa fa-chevron-left"></i> LAN、WLAN、WAN的区别
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2020/09/09/DFS%E5%92%8CBFS%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/" rel="prev" title="DFS和BFS学习记录">
                DFS和BFS学习记录 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  
    <div class="comments" id="comments">
      <div id="disqus_thread">
        <noscript>
          Please enable JavaScript to view the
          <a href="https://disqus.com/?ref_noscript" target="_blank" rel="noopener">comments powered by Disqus.</a>
        </noscript>
      </div>
    </div>

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/me.jpg"
                alt="HZhang" />
            
              <p class="site-author-name" itemprop="name">HZhang</p>
              <p class="site-description motion-element" itemprop="description">╮(￣▽ ￣)╭	</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives">
              
                  <span class="site-state-item-count">7</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                
                  <span class="site-state-item-count">2</span>
                  <span class="site-state-item-name">分类</span>
                
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                
                  <span class="site-state-item-count">9</span>
                  <span class="site-state-item-name">标签</span>
                
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-4"><a class="nav-link" href="#1、HTTP协议"><span class="nav-number">1.</span> <span class="nav-text">1、HTTP协议</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#二、TinyHttpd源码分析"><span class="nav-number">2.</span> <span class="nav-text">二、TinyHttpd源码分析</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1、main"><span class="nav-number">3.</span> <span class="nav-text">1、main()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2、startup"><span class="nav-number">4.</span> <span class="nav-text">2、startup()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3、accept-request"><span class="nav-number">5.</span> <span class="nav-text">3、accept_request()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4、serve-file"><span class="nav-number">6.</span> <span class="nav-text">4、serve_file()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#5、execute-cgi"><span class="nav-number">7.</span> <span class="nav-text">5、execute_cgi()</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">HZhang</span>

  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
    
      <span class="post-meta-item-text">总字数&#58;</span>
    
    <span title="总字数">26.7k</span>
  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.4</div>



        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  

    
      <script id="dsq-count-scr" src="https://.disqus.com/count.js" async></script>
    

    
      <script type="text/javascript">
        var disqus_config = function () {
          this.page.url = 'http://yoursite.com/2020/09/04/Tinyhttpd%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/';
          this.page.identifier = '2020/09/04/Tinyhttpd源码分析/';
          this.page.title = 'Tinyhttpd源码分析';
        };
        var d = document, s = d.createElement('script');
        s.src = 'https://.disqus.com/embed.js';
        s.setAttribute('data-timestamp', '' + +new Date());
        (d.head || d.body).appendChild(s);
      </script>
    

  




	





  





  












  





  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.4.js"></script>
  <script>AV.initialize("aIJmeck02DIo0AzpFF9lzwcY-gzGzoHsz", "1rGGAGoFh7EEihUVQU6YQUVl");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  

  

  
  

  

  

  

</body>
</html>
